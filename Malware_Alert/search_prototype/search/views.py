from django.shortcuts import render
from .utils import check_for_injections, send_telegram_message
from django.http import HttpRequest

def search_products(query):
    # Простой список товаров для примера
    products = [
        {'name': 'Ноутбук', 'description': 'Мощный игровой ноутбук'},
        {'name': 'Телефон', 'description': 'Смартфон из последней линейки'},
        {'name': 'Часы', 'description': 'Наручные Smart часы'},
    ]
    # Фильтрация товаров по запросу
    return [product for product in products if query.lower() in product['name'].lower()]

def search_view(request: HttpRequest):
    query = request.GET.get('q', '')  # Получаем запрос от пользователя
    message = ""  # Инициализация переменной message
    results = []
    ip = request.META.get('REMOTE_ADDR')  # Получаем IP пользователя

    # Проверка на инъекции
    if query:
        is_injection, injection_type = check_for_injections(query)
        if is_injection:
            message = f"Предупреждение: обнаружена попытка инъекции! Тип: {injection_type}"
            # Отправляем сообщение в Telegram
            send_telegram_message(query, ip, injection_type)

    # Поиск товаров
    if query:
        results = search_products(query)

    # Передаем message и результаты в шаблон
    return render(request, 'search/search.html', {'message': message, 'results': results})
